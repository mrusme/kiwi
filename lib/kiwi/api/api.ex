defmodule Kiwi.Api do
    require Logger
    use Kiwi.Server
    use Kiwi.Helpers.Response

    before do
        plug Plug.Logger
        plug Corsica, origins: "*"
        plug Plug.Parsers,
            pass: ["*/*"],
            json_decoder: Jason,
            parsers: [:urlencoded, :json, :multipart]
    end
    resources do
        get do
            body = "<html>
                      <head>
                        <meta charset=\"utf-8\">
                        <title>Kiwi</title>
                        <style type=\"text/css\" media=\"screen\">
                            body {
                                background: #fff url('data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAPVElEQVR4nO3db6yed13H8fs659DpNrd2tU2JigU3CBBI8IEiKZqpONk6MfFPdIlGgjUbjUEmmAqb7YRJzRyipnNbSkJmMCayiNkZYwxTiQTRGOYgDrRjm67A6DSMddXtbOf8DM80Px/0t685N3c+r9fDb/I793Vf1znde9eT7wwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADOwNRac59gQU3T5A+4oLU2LezFQ9GSGwgAeQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQaMVDh+du3vv4r/6VHd1sxFlb5rsOvxXv3hcfXutmI+b9/OattTbfXwDmyhsAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEBTqy7khgVW3Qd/YP/ObjZix0UvKJ3//l/a281GLE3LpfMbbb2bjVi95qbS+Vn4P18Pn1jrZiP+7C8f3+xL/l9aa1M3ZNN4AwAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQaGotfKE2C23e+/wvv35/NxtxxwMHS+fT7b3outIdWH3HkW7GmVtfr/3344abH+tmI1prk8f13HkDAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBoaq22zxkq5r3Pf+/1b+5mI1YfOFQ6z3ztvbD2/FbfeVM3Y/McPnKy9FmttakbBvEGAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACDQ1FppHTvhqvv8d+1c6WYjbj9+ben8HccPdrPNNBUTvG10o829/uI29UX/5+fHv+sd3WzER3/76GZfMv/D4SMnS7ejtVb8C5gvbwAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAk1t0RdyM1fTNJV+gQ7s39nNhryxts970d3w6lrDv/3TG92MM7dl+ezS3Vo7em43Y3EcPlL796e1NnXDTeQNAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAECgqbXSOnfCTdNU+gX6xGPXdLMRd/3ru+f6ADZOndPNRix92+nS+Z94+VXdbMSdX7i1dH59fb2bbaY7D9U+7LLi+aqLt7219BOOvfeD3YzFcfjIydK1ttambjjAGwAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQCseerbqPv99V1zQzUYsP295oe//8vm1ff6XvPiN3WzERtsonX/9S365m41Yvf+W0vmqee/zrzp3+7bF/gIsNG8AACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAKteOhUbN9W+xX66IOHu9kiKa7jn60sbelmm6nNWunTbr+6Gw15zZtq55//8m60UB56/NOL/QUoObB/Z+n8NE2lP2BvAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAAC1Za5Q9GzG0/P9Rbe+NpuNORjX9632Zf8/2qaTaUf9zO/v9zNRmy09fnegDn70pOfjf7+zJc3AAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBVjx0KlprpfO1bfSz2UZxnfyv/003GvKxL76/dP6yl+3rZovkD36s9gB+9e5uFGXXOS8tfd2vze7rZnCmvAEAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACLTioVMxTdWN/jVLy7Xzv/eabjTkrx+v7fO/519u62YjXvfiXyydf/hr/9TNRnz4wStK54/e9qfdbMQLf6B0fO5etK32C/j52X3dDM6UNwAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgVY8dOZrKn566yYj3vap2qev3n9LNxtxztL24uff2s3G1O7f/dNyNxux6Pv8q5aXa/ePxbY05/8F9wYAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAINCKh07F2lptn/ylu6/uZiM+/vCNC/389lx0eTcbcfc/f6B0/qknutGQbzlvvXT+fRd3oyG/dqx2ft7u+M0ji/0FKDl85GTpfGtt6oYDvAEAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACLTioWer7pOepql1wwFv+J1vXej7f+Nru9GQHfd+vHR+7T+70ZA/fF3t/G/8XTcasuj7/C/9nmu72YiPtFs2+5L5JrKxMd9r8QYAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAINDUWmmdO3NW3cc/b8vLU+kKvvOVK91sxCXXPFM6v/2F3WhIm/M+cGqW/uT5pfMbz653MxbH4SMnS9faWqv9A1jkDQAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAoNoy9W8Ci74Pv+p33/t9pZ/w3d97UTcbsbJluXT+y1840c1G3P3n95fO3/bzj3azEU+tlY7P3Xm7alfw5tVutFAu3vbW0uUee/aD3YzFsej7/Ku8AQCAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAINLU233X61X3+n3rium424pEnPls6/5lHb+9mI+a9TPre2uXPXvVT3SjK0rRc+ro/sru2j/6s5XO72YhfeMX1pfMPPfJMNxvxtlv3lM7vOnW6m4349we/VDrPfKXv86/yBgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAg0NRaaR3/bGmpts//3fft7GYjTq3V9kFXfW619gNesbcbDfnMh2rnDx28spuNuOQ7jpbO33XiTd1sxO1/f0vp/Nnn19aBv2THq7vZiD/+rb8tnf+hq7rRmOI29L0XHupmI/ZsrZ1/+5U7utmI5eXodfBl1X38Ven7/Ku8AQCAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAI9I1dyqV9/p/8+nXdbMTq8YNzveuPfr4bDdn10uoV1NZZr77lgm424uZ7frp0ftE9u75W+gY3vesT3WzEK3/2dOn8k7OvdrNFsvfCQ6Wr3bO1dn7fFdu72Yi7jj1ROn/iK890s0ViH/9i8wYAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAINA3djm3ytd+/4cu7WYjju/+yELf9f94uBsN2b67dn7nuS/oZiOet7yldP6Gn3ugm43Y90e16z991r91sxFTcZt52+hGm2ppufZpG+vdaFNduvva0sf94Le/q5ttJvvwWWTeAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEWql+5ePH/qGbjdhz5VWl85+bfbibjfj6018pna/u8686+WRtH37VG95T+wGntxSvv3WTsePF8/NW3ec/zWrr7C+78GA3G7H6zptK56vs8yeZNwAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgVaqX3ntmdpC9U/efHs320wve/1Plj7tRXte1c1GnDj1j6Xz9371L7rZiOoy9HMu6EZRzl7ZWvq6P7z7Ld1sxNNP/lfp/D3v+UA3G7E6q+3zX7KNH+bGGwAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQFNrtX3+0zSVfsCB/Tu7GYujbdR+f2az4vmptlB+Kp6n5vCRk6XzrTUPEJ4jbwAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAk2tVfe510zTNNcLOLB/ZzeDFO87+ljpmz71dO3P1z5/mB9vAAAgkAAAgEACAAACCQAACCQAACCQAACAQAIAAAIJAAAIJAAAIJAAAIBAAgAAAgkAAAgkAAAgkAAAgEACAAACTa3NdR3/3E3TtNA3YOv5y91sxOU/el7p/AVba5+/ZUutQdfWNrrZiIceWSudv/OvTnWzEevr8/31s48fcnkDAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBoam2h1+FTNE2TX4AC+/SBReUNAAAEEgAAEEgAAEAgAQAAgQQAAAQSAAAQSAAAQCABAACBBAAABBIAABBIAABAIAEAAIEEAAAEEgAAEEgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEA8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA+D/MZrP/BqHc659+zXA4AAAAAElFTkSuQmCC') no-repeat center;
                            }
                        </style>
                        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\">
                        <meta name=\"viewport\" content=\"height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no\">
                      </head>
                      <body id=\"the-body\">
                      </body>
                    </html>"
            conn |> html(body)
        end

        mount Kiwi.Api.Settings
    end

    rescue_from Unauthorized, as: e do
        Logger.error("#{inspect e}")

        conn
        |> resp({:unauthorized, %{message: e.message}})
    end

    rescue_from [MatchError, RuntimeError], as: e do
        Logger.error("#{inspect e}")

        conn
        |> resp({:error, e})
    end

    rescue_from Maru.Exceptions.NotFound, as: e do
        Logger.error("#{inspect e}")

        conn
        |> resp({:notfound, %{}})
    end

    rescue_from Maru.Exceptions.InvalidFormat, as: e do
        Logger.error("#{inspect e}")

        conn
        |> resp({:badrequest, %{param: e.param, reason: e.reason}})
    end

    rescue_from Maru.Exceptions.Validation, as: e do
        Logger.error("#{inspect e}")

        conn
        |> resp({:badrequest, %{param: e.param, reason: e.validator}})
    end

    rescue_from :all, as: e do
        Logger.error("#{inspect e}")

        conn
        |> resp({:error, e})
    end
end
